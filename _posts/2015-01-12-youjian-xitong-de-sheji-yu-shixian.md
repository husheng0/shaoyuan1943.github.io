---
layout: post
title: "萌仙系列之邮件系统的设计与实现"
categories: cocos2d-x
---

最近萌发了想就“萌仙”游戏中的相关功能写成一个系列的文章。第一篇就是这个“邮件系统的设计与实现”。

邮件系统在一个游戏是必不可少的功能。是玩家与运营方直接进行沟通以及玩家获得游戏最新活动或消息的最佳手段。因此设计一个好用且稳定的邮件系统是必不可少的。当然，好用与稳定只是针对“萌仙”而言，或许并不适用其他类型的游戏，这里只讨论一下“萌仙”内的邮件系统设计。

邮件一般分玩家邮件（A类）与全服邮件（B类），前者针对某个玩家，后者针对全服所有的玩家。“萌仙”里只有这两类邮件，都是运营方向玩家和全服玩家发的。

####服务端

运营方通过GM工具向中转服务器（transit\_server）提交发邮件的请求（区分A类与B类），中转服务器发送http请求至游戏服务器（zone\_server）,游戏服务器在收到请求后向所有玩家发送邮件。这里邮件还需要判断是否有无附件。

首先决定每一封邮件的数据table:

``` lua
local mail = 
{	
	guid,	-- 邮件唯一标识
	title,	-- 邮件标题
	datetime,	-- 发邮件日期
	text,	-- 邮件正文
	attachment = 	-- 附件
	{
		{"Card", "id", 5},
		{"Card", "id", 5}
	},
	isReaded	-- 是否已经阅读（针对玩家）
};
```

在收到transit\_server的发邮件请求时，将所组合得到mail添加到服务器全局Values中，同时循环玩家列表，对在线玩家发送新邮件请求（OnNewMail），然后将此邮件记录在玩家自身数据中。

同样，对于A类邮件而言，流程与B类邮件一样，只是通过玩家Id找到这个玩家，然后向找到的玩家发送新邮件请求（OnNewMail），同样将邮件记录在玩家自身数据中。

将邮件简化成一个全局Value之后，所有的事情就好办了，增删就仅仅只是对这个全局Value进行增删。

####客户端

客户端玩家在收到OnNewMail请求之后，然后就开始处理之后的逻辑。为了避免服务端频繁的同步邮件数据，客户端在收到OnNewMail请求之后会将邮件通过某种方式写入文件存放在本地，这样即使玩家的历史邮件是一直存在的而不用每次都从服务端同步所有邮件数据。

当然，这种方式还是有弊端的，虽然我们通过某种方式写入文件在本地避免玩家修改其内容，但是仍然避免不了的一个事实就是有些玩家会删除这些邮件文件导致玩家历史邮件丢失。

当玩家新登录时，服务端会同步一次所有的数据，这时玩家会新收到邮件，此时的邮件数据与上面给出的额伪代码一致，唯一需要注意的时当玩家已阅读后需要将此邮件设置为已阅读。

邮件系统的设计大致就如上面所述。当然，文中也涉及到了后面内容从才会说到的问题，比如玩家数据，数据同步等，这些相应的技术实现都会在后面的文章中详细讲解。